@model SIOMS.ViewModels.ProductViewModel
@{
    ViewData["Title"] = "Edit Product";
    var isLowStock = Model.CurrentStock <= Model.MinimumStockLevel;
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-edit"></i> Edit Product
        </h1>
        <div class="btn-group">
            <a asp-action="Details" asp-route-id="@Model.ProductId" class="btn btn-info">
                <i class="fas fa-eye"></i> View Details
            </a>
            <a asp-action="Index" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-box"></i> Product Information
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" id="editProductForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                        <input type="hidden" asp-for="ProductId" />
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="form-label required"></label>
                                    <input asp-for="Name" class="form-control" placeholder="Enter product name" />
                                    <span asp-validation-for="Name" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="SKU" class="form-label"></label>
                                    <input asp-for="SKU" class="form-control" placeholder="Enter SKU (optional)" />
                                    <span asp-validation-for="SKU" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Description" class="form-label"></label>
                            <textarea asp-for="Description" class="form-control" rows="3" 
                                      placeholder="Enter product description (optional)"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                        </div>

                        <!-- Category & Supplier -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="CategoryId" class="form-label required"></label>
                                    <select asp-for="CategoryId" class="form-select" 
                                            asp-items="@(new SelectList(Model.Categories, "CategoryId", "Name"))">
                                        <option value="">-- Select Category --</option>
                                    </select>
                                    <span asp-validation-for="CategoryId" class="text-danger small"></span>
                                    <small class="form-text text-muted">
                                        <a href="@Url.Action("Create", "Categories")" target="_blank" class="text-primary">
                                            <i class="fas fa-plus-circle"></i> Add new category
                                        </a>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="SupplierId" class="form-label"></label>
                                    <select asp-for="SupplierId" class="form-select" 
                                            asp-items="@(new SelectList(Model.Suppliers, "SupplierId", "CompanyName"))">
                                        <option value="">-- Select Supplier (Optional) --</option>
                                    </select>
                                    <span asp-validation-for="SupplierId" class="text-danger small"></span>
                                    <small class="form-text text-muted">
                                        <a href="@Url.Action("Create", "Suppliers")" target="_blank" class="text-primary">
                                            <i class="fas fa-plus-circle"></i> Add new supplier
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Pricing Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-left-primary h-100">
                                    <div class="card-body">
                                        <h6 class="font-weight-bold text-primary mb-3">
                                            <i class="fas fa-money-bill-wave"></i> Buying Information
                                        </h6>
                                        <div class="form-group">
                                            <label asp-for="BuyingPrice" class="form-label required"></label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input asp-for="BuyingPrice" class="form-control" 
                                                       placeholder="0.00" step="0.01" min="0.01" />
                                            </div>
                                            <span asp-validation-for="BuyingPrice" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-left-success h-100">
                                    <div class="card-body">
                                        <h6 class="font-weight-bold text-success mb-3">
                                            <i class="fas fa-tag"></i> Selling Information
                                        </h6>
                                        <div class="form-group">
                                            <label asp-for="SellingPrice" class="form-label required"></label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input asp-for="SellingPrice" class="form-control" 
                                                       placeholder="0.00" step="0.01" min="0.01" />
                                            </div>
                                            <span asp-validation-for="SellingPrice" class="text-danger small"></span>
                                            @if (Model.BuyingPrice > 0 && Model.SellingPrice > 0)
                                            {
                                                var margin = ((Model.SellingPrice - Model.BuyingPrice) / Model.BuyingPrice * 100);
                                                var marginClass = margin >= 20 ? "text-success" : margin >= 10 ? "text-warning" : "text-danger";
                                                <small class="form-text @marginClass">
                                                    <i class="fas fa-chart-line"></i> Margin: @margin.ToString("F1")%
                                                </small>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Information -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold @(isLowStock ? "text-warning" : "text-info")">
                                    <i class="fas fa-warehouse"></i> Stock Information
                                    @if (isLowStock)
                                    {
                                        <span class="badge bg-warning float-end">
                                            <i class="fas fa-exclamation-triangle"></i> Low Stock
                                        </span>
                                    }
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="CurrentStock" class="form-label required"></label>
                                            <input asp-for="CurrentStock" class="form-control" 
                                                   min="0" max="1000000" />
                                            <span asp-validation-for="CurrentStock" class="text-danger small"></span>
                                            <small class="form-text text-muted">
                                                Current quantity in inventory
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="MinimumStockLevel" class="form-label required"></label>
                                            <input asp-for="MinimumStockLevel" class="form-control" 
                                                   min="0" max="1000000" />
                                            <span asp-validation-for="MinimumStockLevel" class="text-danger small"></span>
                                            <small class="form-text text-muted">
                                                Low stock alert will trigger below this level
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock Status Visual -->
                                <div class="mt-4">
                                    <h6 class="font-weight-bold mb-3">Stock Status</h6>
                                    @{
                                        var stockPercentage = Model.MinimumStockLevel > 0 ? 
                                            (Math.Min(Model.CurrentStock, Model.MinimumStockLevel * 2) * 100) / (Model.MinimumStockLevel * 2) : 
                                            (Model.CurrentStock > 0 ? 100 : 0);
                                        var stockColor = isLowStock ? "bg-warning" : 
                                                        Model.CurrentStock == 0 ? "bg-danger" : "bg-success";
                                    }
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar @stockColor" role="progressbar" 
                                             style="width: @stockPercentage%;" 
                                             aria-valuenow="@stockPercentage" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            @Model.CurrentStock units
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4 text-center">
                                            <small class="text-danger">
                                                <i class="fas fa-times-circle"></i> Out of Stock
                                            </small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-warning">
                                                <i class="fas fa-exclamation-triangle"></i> Low Stock
                                            </small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-success">
                                                <i class="fas fa-check-circle"></i> Good Stock
                                            </small>
                                        </div>
                                    </div>
                                    
                                    @if (isLowStock)
                                    {
                                        <div class="alert alert-warning mt-3">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>Low Stock Alert!</strong> Current stock (@Model.CurrentStock) is below 
                                            minimum level (@Model.MinimumStockLevel). Consider updating stock or adjusting minimum level.
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-group mt-4">
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                    <a asp-action="Delete" asp-route-id="@Model.ProductId" 
                                       class="btn btn-outline-danger" id="deleteBtn">
                                        <i class="fas fa-trash"></i> Delete Product
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-4">
            <!-- Summary Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle"></i> Product Summary
                    </h6>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Product ID:</dt>
                        <dd class="col-sm-6">@Model.ProductId</dd>
                        
                        <dt class="col-sm-6">Last Updated:</dt>
                        <dd class="col-sm-6">@DateTime.Now.ToString("MMM dd, yyyy")</dd>
                        
                        <dt class="col-sm-6">Stock Value:</dt>
                        <dd class="col-sm-6 font-weight-bold text-primary">
                            @((Model.CurrentStock * Model.BuyingPrice).ToString("C"))
                        </dd>
                        
                        <dt class="col-sm-6">Sales Value:</dt>
                        <dd class="col-sm-6 font-weight-bold text-success">
                            @((Model.CurrentStock * Model.SellingPrice).ToString("C"))
                        </dd>
                        
                        <dt class="col-sm-6">Total Margin:</dt>
                        <dd class="col-sm-6 font-weight-bold @(((Model.SellingPrice - Model.BuyingPrice) * Model.CurrentStock) >= 0 ? "text-success" : "text-danger")">
                            @(((Model.SellingPrice - Model.BuyingPrice) * Model.CurrentStock).ToString("C"))
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="UpdateStock" asp-route-id="@Model.ProductId" 
                           class="btn btn-outline-primary btn-block text-left mb-2">
                            <i class="fas fa-warehouse"></i> Update Stock Level
                        </a>
                        <button type="button" class="btn btn-outline-info btn-block text-left mb-2" 
                                onclick="duplicateProduct()">
                            <i class="fas fa-copy"></i> Duplicate Product
                        </button>
                        <a href="@Url.Action("Create", "PurchaseOrders")?productId=@Model.ProductId" 
                           class="btn btn-outline-success btn-block text-left mb-2">
                            <i class="fas fa-truck-loading"></i> Create Purchase Order
                        </a>
                        <a href="@Url.Action("Create", "SalesOrders")?productId=@Model.ProductId" 
                           class="btn btn-outline-warning btn-block text-left mb-2">
                            <i class="fas fa-cash-register"></i> Create Sales Order
                        </a>
                    </div>
                </div>
            </div>

            <!-- Validation Tips Card -->
            <div class="card shadow mb-4 border-left-info">
                <div class="card-header py-3 bg-info">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-lightbulb"></i> Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            <small>Ensure product name is descriptive and unique</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            <small>Set minimum stock level based on sales history</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            <small>Selling price should cover costs + desired margin</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            <small>Regularly update stock counts for accuracy</small>
                        </li>
                        <li>
                            <i class="fas fa-check-circle text-success"></i>
                            <small>Assign to categories for better organization</small>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Audit Trail Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> Recent Changes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="font-weight-bold">Last Updated</h6>
                                <p class="text-muted small">Just now (Current edit session)</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6 class="font-weight-bold">Stock Check</h6>
                                <p class="text-muted small">Yesterday</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="font-weight-bold">Created</h6>
                                <p class="text-muted small">@DateTime.Now.AddDays(-30).ToString("MMM dd, yyyy")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate Product Modal -->
<div class="modal fade" id="duplicateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-copy"></i> Duplicate Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This will create a copy of the current product with a new SKU. Do you want to continue?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> The new product will have "-COPY" appended to the name.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmDuplicate()">Duplicate</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/edit-product.css" asp-append-version="true" />

@section Scripts {
    <script>
        $(document).ready(function() {
            // Delete confirmation
            $('#deleteBtn').click(function(e) {
                if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                    e.preventDefault();
                }
            });
            
            // Real-time margin calculation
            function calculateMargin() {
                var buying = parseFloat($('#BuyingPrice').val()) || 0;
                var selling = parseFloat($('#SellingPrice').val()) || 0;
                
                if (buying > 0 && selling > 0) {
                    var margin = ((selling - buying) / buying * 100);
                    var marginElement = $('#marginDisplay');
                    
                    if (!marginElement.length) {
                        $('#SellingPrice').after('<small class="form-text" id="marginDisplay"></small>');
                        marginElement = $('#marginDisplay');
                    }
                    
                    var marginClass = margin >= 20 ? 'text-success' : margin >= 10 ? 'text-warning' : 'text-danger';
                    marginElement.removeClass('text-success text-warning text-danger').addClass(marginClass);
                    marginElement.html('<i class="fas fa-chart-line"></i> Margin: ' + margin.toFixed(1) + '%');
                }
            }
            
            $('#BuyingPrice, #SellingPrice').on('input', calculateMargin);
            
            // Real-time stock status update
            function updateStockStatus() {
                var current = parseInt($('#CurrentStock').val()) || 0;
                var minimum = parseInt($('#MinimumStockLevel').val()) || 0;
                
                var stockPercentage = minimum > 0 ? 
                    (Math.min(current, minimum * 2) * 100) / (minimum * 2) : 
                    (current > 0 ? 100 : 0);
                
                var stockColor = current <= minimum ? 'bg-warning' : 
                                current == 0 ? 'bg-danger' : 'bg-success';
                
                $('.progress-bar')
                    .css('width', stockPercentage + '%')
                    .attr('aria-valuenow', stockPercentage)
                    .removeClass('bg-warning bg-danger bg-success')
                    .addClass(stockColor)
                    .text(current + ' units');
                
                // Update stock alert
                var alertElement = $('#stockAlert');
                if (current <= minimum) {
                    if (!alertElement.length) {
                        $('.progress').after('<div class="alert alert-warning mt-3" id="stockAlert"></div>');
                        alertElement = $('#stockAlert');
                    }
                    alertElement.html('<i class="fas fa-exclamation-triangle"></i> ' +
                        '<strong>Low Stock Alert!</strong> Current stock (' + current + ') is below minimum level (' + minimum + ').');
                } else {
                    alertElement.remove();
                }
            }
            
            $('#CurrentStock, #MinimumStockLevel').on('input', updateStockStatus);
            
            // Form validation
            $('#editProductForm').on('submit', function(e) {
                var isValid = true;
                var requiredFields = ['Name', 'CategoryId', 'BuyingPrice', 'SellingPrice', 
                                      'CurrentStock', 'MinimumStockLevel'];
                
                requiredFields.forEach(function(field) {
                    var element = $('#' + field);
                    if (!element.val().trim()) {
                        isValid = false;
                        element.addClass('is-invalid');
                    } else {
                        element.removeClass('is-invalid');
                    }
                });
                
                // Validate prices
                var buyingPrice = parseFloat($('#BuyingPrice').val());
                var sellingPrice = parseFloat($('#SellingPrice').val());
                
                if (buyingPrice <= 0) {
                    $('#BuyingPrice').addClass('is-invalid');
                    isValid = false;
                }
                
                if (sellingPrice <= 0) {
                    $('#SellingPrice').addClass('is-invalid');
                    isValid = false;
                }
                
                if (sellingPrice < buyingPrice) {
                    alert('Selling price cannot be less than buying price!');
                    $('#SellingPrice').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                    $('.alert-danger').show();
                }
            });
            
            // Initialize calculations
            calculateMargin();
            updateStockStatus();
        });
        
        function resetForm() {
            if (confirm('Reset all changes to original values?')) {
                location.reload();
            }
        }
        
        function duplicateProduct() {
            var modal = new bootstrap.Modal(document.getElementById('duplicateModal'));
            modal.show();
        }
        
        function confirmDuplicate() {
            var formData = $('#editProductForm').serializeArray();
            var duplicateData = {};
            
            formData.forEach(function(item) {
                duplicateData[item.name] = item.value;
            });
            
            // Modify for duplicate
            duplicateData.ProductId = 0;
            duplicateData.Name = duplicateData.Name + ' - COPY';
            duplicateData.SKU = duplicateData.SKU ? duplicateData.SKU + '-COPY' : '';
            
            $.ajax({
                url: '@Url.Action("Create")',
                type: 'POST',
                data: duplicateData,
                success: function(response) {
                    if (response.success) {
                        alert('Product duplicated successfully!');
                        window.location.href = '@Url.Action("Index")';
                    } else {
                        alert('Error duplicating product: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error duplicating product. Please try again.');
                }
            });
        }
        
        // Auto-suggest SKU from name
        $('#Name').on('blur', function() {
            var name = $(this).val();
            var skuField = $('#SKU');
            
            if (name && !skuField.val()) {
                // Generate simple SKU from name
                var sku = name.toUpperCase()
                    .replace(/[^A-Z0-9]/g, '')
                    .substring(0, 8);
                
                if (sku.length > 0) {
                    skuField.val(sku + '-001');
                }
            }
        });
    </script>
    
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}